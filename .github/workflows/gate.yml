name: Gate

on:
  - push
  - pull_request

jobs:
  gate:
    runs-on: ubuntu-latest
    permissions:
      # Required to checkout the code
      contents: write
      # Required to put a comment into the pull-request
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.6.x
          cache: true
      - name: Type & Format checking
        run: deno task --quiet lint
      - name: Check dependencies
        run: deno task --quiet deps
      - name: Run tests
        id: tests
        continue-on-error: true
        run: deno task --quiet test-coverage
      - name: Generate coverage report
        continue-on-error: true
        run: deno task --quiet coverage-report
      - name: Check coverage requirements
        id: coverage
        continue-on-error: true
        working-directory: gate
        run: deno task --quiet coverage-check > "$GITHUB_OUTPUT"
      - name: Update and commit badges
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          # Determine test status
          if [ "${{ steps.tests.outcome }}" == "success" ]; then
            TEST_STATUS="passing"
          else
            TEST_STATUS="failing"
          fi

          # Run the update script
          ./scripts/update-badges.sh "$TEST_STATUS" "${{ steps.coverage.outputs.percentage }}"
